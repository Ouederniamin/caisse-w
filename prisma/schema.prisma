generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TourStatus {
  PESEE_VIDE            // Truck weighed empty by security, waiting for loading
  EN_CHARGEMENT         // Being loaded by Agent Contrôle
  PRET_A_PARTIR         // Loaded, ready to leave
  EN_TOURNEE            // On delivery route (after pesée sortie)
  RETOUR                // Returned (marked by security, no weighing)
  EN_ATTENTE_DECHARGEMENT // Waiting for Agent Contrôle to unload
  EN_ATTENTE_HYGIENE    // Waiting for hygiene check
  TERMINEE              // Complete
}

enum ConflictStatus {
  EN_ATTENTE
  PAYEE      // Legacy - kept for backwards compatibility
  ANNULE     // Legacy - kept for backwards compatibility  
  RESOLUE    // New status for fully resolved conflicts
}

enum MouvementType {
  INITIALISATION
  DEPART_TOURNEE
  RETOUR_TOURNEE
  SURPLUS
  RETOUR_CONFLIT
  PERTE_CONFIRMEE
  AJUSTEMENT
  ACHAT
}

enum ResolutionType {
  RETOUR_CAISSES
  PAIEMENT
}

enum ModePaiement {
  ESPECES
  RETENUE_SALAIRE
}

// --- Auth Models (BetterAuth) ---

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified Boolean?
  image         String?
  password_hash String?   // For mobile backend plain text auth (dev mode)
  role          String    @default("AGENT_CONTROLE") // ADMIN, DIRECTION, AGENT_CONTROLE, AGENT_HYGIENE, SECURITE
  expoPushToken String?   // Expo push notification token for mobile app
  banned        Boolean?
  banReason     String?
  banExpires    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // BetterAuth relations
  sessions      Session[]
  accounts      Account[]

  // Business relations
  toursControle Tour[] @relation("AgentControle")
  toursHygiene  Tour[] @relation("AgentHygiene")
  toursSecuriteSortie Tour[] @relation("SecuriteSortie")
  toursSecuriteEntree Tour[] @relation("SecuriteEntree")
  notifications Notification[]
  auditLogs     AuditLog[]
  resolutionsEffectuees ResolutionConflict[]
  mouvementsStock       MouvementCaisse[]

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id           String    @id @default(cuid())
  userId       String
  accountId    String
  providerId   String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  password     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

// --- Business Models ---

model Driver {
  id                          String   @id @default(uuid())
  nom_complet                 String
  matricule_par_defaut        String?
  marque_vehicule             String?
  poids_tare_vehicule         Float?   // Default vehicle tare weight in kg
  tolerance_caisses_mensuelle Int      @default(0)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  tours Tour[]
}

model Secteur {
  id        String   @id @default(uuid())
  nom       String   @unique
  tours     Tour[]
}

model CaisseConfig {
  id         String @id @default(uuid())
  nom        String
  valeur_tnd Float
}

model Produit {
  id           String   @id @default(uuid())
  code_article String   @unique
  nom          String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  lignesRetour LigneRetourProduit[]
}

model Tour {
  id String @id @default(uuid())
  
  driverId String?
  driver   Driver? @relation(fields: [driverId], references: [id])

  secteurId String?
  secteur   Secteur? @relation(fields: [secteurId], references: [id])
  
  // Multi-secteur support: store all selected secteur names as comma-separated string
  secteurs_noms String?  // e.g. "Tunis Centre, Ariana, Ben Arous"

  agentControleId String?
  agentControle   User?   @relation("AgentControle", fields: [agentControleId], references: [id])

  agentHygieneId String?
  agentHygiene   User?   @relation("AgentHygiene", fields: [agentHygieneId], references: [id])

  securiteIdSortie String?
  securiteSortie   User?   @relation("SecuriteSortie", fields: [securiteIdSortie], references: [id])

  securiteIdEntree String?
  securiteEntree   User?   @relation("SecuriteEntree", fields: [securiteIdEntree], references: [id])

  matricule_vehicule String

  nbre_caisses_depart Int      @default(0)  // Set during chargement by Agent Contrôle
  nbre_caisses_retour Int?

  poids_net_produits_depart Float @default(0)  // Set during chargement
  
  // Pesée à vide (empty truck weighing - when driver arrives)
  poids_a_vide    Float?    // Empty truck weight
  date_pesee_vide DateTime? // When empty weighing was done
  
  // Pesée sortie (loaded truck weighing - when driver leaves after chargement)
  poids_brut_securite_sortie Float?
  
  // Retour (just marking arrival, no weighing in new flow)
  date_retour_securite DateTime? // When security marked arrival (no pesée)
  
  // Legacy fields kept for compatibility
  poids_brut_securite_retour Float?
  poids_tare_securite        Float?
  poids_net_total_calcule    Float?

  photo_preuve_depart_url String?
  photo_preuve_retour_url String?
  photos_hygiene_urls     String[] // Array of photo URLs for hygiene checks
  
  notes_hygiene           String?
  statut_hygiene          String? // APPROUVE, REJETE
  
  matricule_verifie_sortie Boolean @default(false)
  matricule_verifie_retour Boolean @default(false)

  date_sortie_securite DateTime? // When driver left with loaded truck
  date_entree_securite DateTime? // Legacy - use date_retour_securite instead
  date_sortie_finale   DateTime? // When vehicle exits after TERMINEE

  statut TourStatus @default(PESEE_VIDE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lignesRetour LigneRetourProduit[]
  conflicts    Conflict[]
  mouvementsCaisse MouvementCaisse[]
}

model LigneRetourProduit {
  id String @id @default(uuid())
  
  tourId String
  tour   Tour   @relation(fields: [tourId], references: [id])

  produitId String
  produit   Produit @relation(fields: [produitId], references: [id])

  nbre_caisses      Int
  poids_brut_retour Float
  poids_net_retour  Float
  note_etat         String?
}

model Conflict {
  id String @id @default(uuid())

  tourId String
  tour   Tour   @relation(fields: [tourId], references: [id])

  // Initial values (immutable after creation)
  quantite_perdue   Int
  montant_dette_tnd Float
  
  // Resolution tracking (updated progressively)
  caisses_retournees Int   @default(0)
  montant_paye       Float @default(0)
  
  statut ConflictStatus @default(EN_ATTENTE)

  notes_direction            String?
  direction_id_approbation   String? 
  date_approbation_direction DateTime?
  depasse_tolerance          Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  resolutions ResolutionConflict[]
  mouvements  MouvementCaisse[]
}

model ResolutionConflict {
  id String @id @default(uuid())
  
  conflictId String
  conflict   Conflict @relation(fields: [conflictId], references: [id])
  
  type         ResolutionType
  quantite     Int?           // For RETOUR_CAISSES
  montant      Float?         // For PAIEMENT
  modePaiement ModePaiement?  // Only for PAIEMENT
  
  userId String
  user   User   @relation(fields: [userId], references: [id])
  notes  String?
  
  createdAt DateTime @default(now())
  
  @@map("resolution_conflict")
}

model StockCaisse {
  id                String   @id @default("stock-principal")
  stock_initial     Int      @default(0)
  stock_actuel      Int      @default(0)
  seuil_alerte_pct  Int      @default(10)
  dernier_stock_ref Int      @default(0)
  initialise        Boolean  @default(false)
  updatedAt         DateTime @updatedAt
  
  @@map("stock_caisse")
}

model MouvementCaisse {
  id          String        @id @default(uuid())
  type        MouvementType
  quantite    Int
  solde_apres Int
  
  tourId     String?
  tour       Tour?     @relation(fields: [tourId], references: [id])
  conflictId String?
  conflict   Conflict? @relation(fields: [conflictId], references: [id])
  userId     String?
  user       User?     @relation(fields: [userId], references: [id])
  notes      String?
  
  createdAt DateTime @default(now())
  
  @@map("mouvement_caisse")
}

model AppConfig {
  id    String @id @default(uuid())
  key   String @unique
  value String
  
  @@map("app_config")
}

model WiFiConfig {
  id          String   @id @default(uuid())
  ssid        String
  bssid       String   // MAC address of the WiFi router (prevents SSID spoofing)
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([ssid, bssid])
  @@map("wifi_config")
}

model Notification {
  id String @id @default(uuid())
  
  userId String
  user   User   @relation(fields: [userId], references: [id])

  message String
  isRead  Boolean @default(false)
  
  createdAt DateTime @default(now())
}

model AuditLog {
  id String @id @default(uuid())
  
  userId String
  user   User   @relation(fields: [userId], references: [id])

  action        String
  targetId      String?
  details_avant String? 
  details_apres String? 
  
  timestamp DateTime @default(now())
}
